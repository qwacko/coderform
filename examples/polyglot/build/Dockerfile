# Base Ubuntu image - runtimes installed during startup
ARG UBUNTU_VERSION=latest
FROM ubuntu:${UBUNTU_VERSION}

ARG ADDITIONAL_PACKAGES=""

# Install base dependencies (required for runtime installers and Coder)
RUN apt-get update && \
    apt-get install -y \
        curl \
        wget \
        git \
        build-essential \
        ca-certificates \
        gnupg \
        lsb-release \
        software-properties-common \
        sudo \
        jq \
        socat \
        vim \
        htop \
        tmux \
        iputils-ping \
        ${ADDITIONAL_PACKAGES} \
        && rm -rf /var/lib/apt/lists/*

# Create coder user
RUN useradd -m -s /bin/bash coder && \
    echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/coder && \
    chmod 0440 /etc/sudoers.d/coder

# Install selected development runtimes (run as coder user so ~/.bashrc is correct)
# Note: install-runtimes.sh is generated by the runtime-installer module and written by local_file resource
COPY install-runtimes.sh /home/coder/install-runtimes.sh
RUN chown coder:coder /home/coder/install-runtimes.sh && \
    chmod +x /home/coder/install-runtimes.sh && \
    su - coder -c "/home/coder/install-runtimes.sh" && \
    rm /home/coder/install-runtimes.sh

USER coder
WORKDIR /home/coder
